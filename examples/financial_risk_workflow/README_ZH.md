# 金融风险评估工作流 - LanggraphClient

## 🎯 整体业务场景

这是一个**投资组合风险管理系统**，模拟了银行或资产管理公司的风险评估流程。

**实际业务流程：**
假设你是一家资产管理公司的风险管理经理，客户委托你管理1亿元投资组合（60%股票 + 30%债券 + 10%现金）。在投资前，你需要评估这个组合可能面临的各种风险，给客户提供一份专业的风险评估报告。

## 📊 工作流执行流程

```
1. 投资组合描述输入
   ↓
2. [LLM智能分析] 提取关键参数
   ↓
3. 并行执行三个风险评估 (同时进行，节省时间)
   ├─ [市场风险] 计算可能的市场损失
   ├─ [信用风险] 评估违约风险
   └─ [流动性风险] 测试变现能力
   ↓
4. [汇总报告] 生成综合风险评估
```

## 🔍 每个函数的详细作用

### 1. llm_analysis_node - LLM 智能分析节点

**业务作用：** 就像一个经验丰富的金融分析师，阅读投资组合的文字描述，自动提取关键数据。

**输入：**
```
"混合型投资组合，总规模1亿元人民币，
包含60%股票、30%债券、10%现金，
投资期限1年，风险偏好为中等。"
```

**LLM做什么：**
- 理解这段自然语言描述
- 提取关键参数：总价值、波动率、置信水平、时间跨度等
- 将文字转换为可计算的数值参数

**输出：**
```python
{
    "portfolio_value": 10000,      # 1亿元
    "volatility": 0.25,            # 波动率25%
    "confidence_level": 0.95,      # 95%置信度
    "num_simulations": 500000,     # 模拟50万次
    "time_horizon": 252            # 1年(252个交易日)
}
```

**为什么需要LLM？** 
在实际业务中，客户或业务部门提供的是文字描述，不是结构化数据。LLM可以自动理解并提取，省去人工录入的工作。

---

### 2. market_risk_var_tool - 市场风险评估工具

**业务作用：** 回答"如果市场下跌，最坏情况下我会损失多少钱？"

**使用算法：** 蒙特卡洛模拟 + VaR (Value at Risk) 计算

**具体做什么：**
1. **模拟50万条未来价格路径**
   - 每条路径代表一种可能的市场走势
   - 使用几何布朗运动模型（金融市场标准模型）
   - 考虑波动率：25%（市场每天的价格波动）

2. **计算VaR值**
   - 在95%置信水平下，找出最差的5%情况
   - 这5%情况下的平均损失就是VaR

**实际业务意义：**
```
输出结果示例：
"在95%的概率下，1年内最大损失不会超过2500万元"
```
这告诉客户：正常情况下（95%概率），损失不会超过这个数。但还有5%的极端情况可能损失更多。


---

### 3. credit_risk_monte_carlo_tool - 信用风险评估工具

**业务作用：** 回答"如果债券发行方违约，我会损失多少？"

**业务背景：** 
投资组合中有30%是企业债券。企业可能破产违约，导致本金损失。

**具体做什么：**
1. **假设100个债券发行人**
   - 每个发行人有2%的违约概率
   - 违约后损失60%的本金

2. **模拟50万次违约场景**
   - 每次随机决定哪些企业违约
   - 计算每种情况下的总损失

3. **统计分析**
   - 预期损失：平均情况下损失多少
   - 95% CVaR：95%概率下的最大损失
   - 99% CVaR：99%概率下的最大损失

**实际业务意义：**
```
输出结果示例：
"预期损失：120万元
95%置信度下最大损失：350万元
99%置信度下最大损失：520万元"
```

这帮助客户了解：平均会损失120万，但极端情况可能损失500多万。

---

### 4. liquidity_risk_stress_test_tool - 流动性风险评估工具

**业务作用：** 回答"如果突然需要变现，会损失多少？"

**业务背景：**
客户可能突然需要赎回资金（比如紧急用钱）。此时需要快速卖出资产，但市场可能没有足够买家，导致被迫降价出售。

**具体做什么：**
1. **模拟1000个压力场景**
   - 不同的赎回压力（客户要拿回多少钱）
   - 不同的市场流动性状况（买家多不多）

2. **每个场景模拟500次** (共50万次)
   - 赎回率：客户要拿回多少比例的钱
   - 变现折价：紧急卖出时被迫降价多少（5%-30%）
   - 现金储备：手上有多少现金可以直接给客户

3. **计算流动性损失**
   - 如果现金不够，需要卖资产
   - 卖资产时的折价损失

**实际业务意义：**
```
输出结果示例：
"平均流动性损失：180万元
最大流动性损失：850万元
95%分位数：420万元"
```

这告诉客户：如果需要紧急赎回，平均损失180万，最坏可能损失850万。

---

### 5. generate_report_node - 综合报告生成节点

**业务作用：** 把三个维度的风险评估结果整合成一份完整报告

**具体做什么：**
- 收集前面三个工具的评估结果
- 按格式排版
- 输出一份专业的风险评估报告

**输出示例：**
```
====================================
投资组合综合风险评估报告
====================================

【风险维度 1】市场风险
- VaR值：2500万元
- 最大潜在损失占比：25%

【风险维度 2】信用风险
- 预期损失：120万元
- 95% CVaR：350万元

【风险维度 3】流动性风险
- 平均流动性损失：180万元
- 最大流动性损失：850万元
====================================
```


## 🎓 工作流总结

这个工作流模拟了一个**完整的投资组合风险管理流程**：

1. **自然语言理解** (LLM) → 提取参数
2. **并行风险计算** (3个工具) → 多维度评估  
3. **报告生成** → 给客户看的专业报告

在真实业务中，这样的系统可以：
- 自动处理客户的投资意向
- 快速评估各类风险
- 生成符合监管要求的报告
- 帮助投资经理做决策

## 运行流程


### 1. 安装依赖

```bash
pip install -r requirements.txt
```

## 2. 配置API Key

设置通义千问 API Key：

```bash
export DASHSCOPE_API_KEY="your_api_key_here"
```

## 3.启动Maze
启动Maze Head（如果有多台机器，可启动Maze worker）
```bash
mazea start --head 
```
## 4.运行main.py

```bash
python main.py
```
 