# 多模态创意内容生成工作流

## 🎯 整体业务场景

这是一个**多模态创意内容生成系统**，展示了分布式工作流中并行处理和异构资源调度的强大能力。

**实际业务流程：**
假设你是一名内容创作者，需要快速生成多种类型的创意素材。给定一个文本描述，系统会自动生成：
- 📝 一篇创意故事（文本）
- 🖼️ 一张配图（图像）
- 🔊 一段语音旁白（音频）

这三种内容类型**并行生成**，高效利用 CPU 和 GPU 资源。

## 📊 工作流执行流程

```
1. 用户输入描述
   ↓
2. [文本预处理] 为不同模态优化提示词
   ↓
3. 并行内容生成（同时进行，最大化效率）
   ├─ [文本生成] GPT-2 Large 生成创意故事 (CPU)
   ├─ [图像生成] Stable Diffusion 创作艺术作品 (GPU)
   └─ [音频生成] Bark 合成语音旁白 (CPU)
   ↓
4. [结果汇总] 将所有输出整合到 HTML 展示页面
```

## 🔍 每个函数的详细作用

### 1. preprocess_and_enhance - 预处理节点

**业务作用：** 充当智能提示词工程师，为每个内容生成模型优化用户输入。

**输入：**
```
"夕阳下的魔法森林"
```

**具体做什么：**
- 为故事生成创建详细提示
- 为图像生成优化描述（添加质量关键词）
- 为音频合成准备简洁文本

**输出：**
```python
{
    "enhanced_text_prompt": "写一个关于夕阳下的魔法森林的创意短篇故事...",
    "enhanced_image_prompt": "a magical forest at sunset, highly detailed, digital art...",
    "audio_text": "This is a story about a magical forest at sunset."
}
```

**为什么需要预处理？**
不同的 AI 模型有不同的"语言"。文本模型需要叙事性提示，而图像模型更适合带有质量描述符的提示（如 "8k uhd"、"trending on artstation"）。

---

### 2. generate_story - 文本故事生成（CPU 任务）

**业务作用：** 基于用户主题创建引人入胜的叙事故事。

**使用模型：** GPT-2 Large（7.74亿参数）

**具体做什么：**
1. **加载 GPT-2 Large 模型**
   - 7.74亿参数的语言模型
   - 针对创意文本生成优化

2. **生成创意内容**
   - Temperature: 0.8（创意随机性）
   - 最大长度：300 tokens
   - 输出连贯的叙事文本

3. **保存结果**
   - 保存故事到 `generated_story.txt`
   - 返回故事内容和文件路径

**资源需求：**
- CPU：4核
- 内存：4GB RAM
- 无需 GPU

**实际业务意义：**
```
输出示例：
"很久以前，在一片魔法森林里，古老的树木向风儿低语着秘密，
一位年轻的旅行者发现了一条被夕阳金光照亮的隐秘小径..."
```

这为创意内容提供了文本基础，可用于文章、剧本或故事讲述。

---

### 3. generate_image - 图像生成（GPU 任务）

**业务作用：** 创建与主题匹配的高质量艺术作品。

**使用模型：** Stable Diffusion v1.5

**具体做什么：**
1. **加载 Stable Diffusion 管道**
   - 先进的文本转图像模型
   - FP16 精度以提高内存效率
   - 针对 NVIDIA GPU 优化

2. **生成高质量图像**
   - 50 个推理步骤以保证质量
   - 512x512 分辨率
   - 引导比例：7.5（提示词遵从度）

3. **保存并清理**
   - 保存为 `generated_image.png`
   - 生成后清理 GPU 内存

**资源需求：**
- GPU：1个（RTX 4090 或类似）
- 显存：8GB
- CPU：2核
- 内存：2GB RAM

**实际业务意义：**
```
输出：高质量数字艺术作品
- 分辨率：512x512
- 风格：专业数字艺术
- 适用于：社交媒体、演示文稿、营销
```

这展示了**异构资源调度**：当 CPU 处理文本生成时，GPU 全力专注于图像生成。

---

### 4. generate_audio - 音频合成（CPU 任务）

**业务作用：** 将文本转换为自然流畅的语音旁白。

**使用模型：** Bark TTS（文本转语音）

**具体做什么：**
1. **加载 Bark 模型**
   - 神经文本转语音合成
   - 自然、类人的语音质量
   - 支持多种说话风格

2. **合成音频**
   - 将文本转换为语音波形
   - 采样率：24kHz
   - 自然的韵律和语调

3. **导出音频文件**
   - 保存为 `generated_audio.wav`
   - 计算并报告时长

**资源需求：**
- CPU：4核
- 内存：4GB RAM
- 无需 GPU

**实际业务意义：**
```
输出：自然语音旁白
- 时长：约5-10秒
- 质量：类人自然语音
- 用例：播客、有声书、无障碍访问
```

这通过添加听觉维度完成了多模态生成。

---

### 5. summarize_results - 结果汇总节点

**业务作用：** 将所有生成的内容整合到统一、精美的展示中。

**具体做什么：**
- 收集所有生成的文件（故事、图像、音频）
- 创建交互式 HTML 展示页面
- 生成元数据和统计信息
- 提供易于分享的结果页面

**输出：**
```
HTML 报告包含：
- 带格式的完整故事文本
- 嵌入的高质量图像
- 可播放的音频控件
- 模型信息和生成统计
- 性能指标（并行执行时间）
```

**为什么重要：**
在实际业务场景中，这个汇总输出可以：
- 立即与客户分享
- 用于演示或展示
- 直接发布到网络平台
- 归档用于作品集审查

---

## 🎓 工作流总结

这个工作流展示了一个**完整的多模态内容创作流水线**：

1. **智能预处理** → 为每个模型优化提示词
2. **并行生成**（3个任务）→ 通过并发最大化效率
3. **异构资源** → CPU 和 GPU 任务独立调度
4. **统一输出** → 专业展示即可使用

在实际业务应用中，这样的系统可以：
- **节省时间**：并行执行将总时间从5+分钟减少到约2分钟
- **优化资源**：CPU 和 GPU 同时工作，而非顺序执行
- **易于扩展**：添加更多 worker 以同时处理多个请求
- **专业输出**：自动生成可用于生产的内容

## ⚡ 核心特性

### 1. 并行执行
- 任务 B、C、D 同时运行
- 总时间 = max(B_时间, C_时间, D_时间)，而非 B + C + D
- **实际性能**：比顺序执行快约2倍

### 2. 异构资源调度
- **CPU 任务**：文本生成、音频合成
- **GPU 任务**：图像生成（需要 CUDA）
- 自动资源分配和管理

### 3. 自动依赖管理
- 任务 A 完成后 B/C/D 才开始
- 任务 B/C/D 的输出传递给任务 E
- 无需手动协调

## 📋 运行流程

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 启动 Maze

启动 Maze Head（如果有多台机器，可以启动 Maze worker）：

```bash
maze start --head
```

### 3. 运行工作流

```bash
python main.py
```

### 4. 输入您的主题

```
请输入您想要创作的主题: 未来城市的夜晚
```

### 5. 查看结果

工作流将生成：
```
outputs/
├── generated_story.txt          # 创意故事
├── generated_image.png          # AI 生成的艺术作品
├── generated_audio.wav          # 语音旁白
└── result.html                  # ⭐ 完整展示（打开这个！）
```

在浏览器中打开 `result.html`，以精美的交互式格式查看所有生成的内容！

## 🎨 示例输出

输入：**"夕阳下的魔法森林"**

您将获得：
- **故事**：300字的关于魔法森林的创意叙事
- **图像**：高质量 512x512 数字艺术作品
- **音频**：约10秒的语音旁白
- **HTML**：专业展示页面

## 💡 技术亮点

### 使用的模型
| 任务 | 模型 | 大小 | 设备 | 用途 |
|------|------|------|------|------|
| 文本 | GPT-2 Large | 774M | CPU | 故事生成 |
| 图像 | Stable Diffusion v1.5 | ~4GB | GPU | 艺术创作 |
| 音频 | Bark TTS | ~1GB | CPU | 语音合成 |

### 资源分配
```python
Task A: CPU=1, 内存=512MB   (轻量级预处理)
Task B: CPU=4, 内存=4GB     (文本生成)
Task C: GPU=1, 显存=8GB     (图像生成)
Task D: CPU=4, 内存=4GB     (音频合成)
Task E: CPU=1, 内存=512MB   (结果汇总)
```

## 🔧 自定义

您可以轻松自定义工作流：

1. **更换模型**：在代码中替换为您喜欢的模型
2. **调整质量**：修改生成参数（步数、温度等）
3. **添加更多任务**：扩展视频生成、翻译等功能
4. **横向扩展**：添加更多 worker 以处理多个并发请求

## 📝 注意事项

- 首次运行将下载模型（总计约 8GB）
- 图像生成需要 NVIDIA GPU
- 可使用纯 CPU 模式（图像生成较慢）
- 输出目录：`example/outputs/`

## 🎯 使用场景

此工作流非常适合：
- **内容创作者**：快速生成创意素材
- **营销团队**：多格式营销资产
- **教育领域**：展示 AI 能力
- **研究人员**：测试分布式 AI 工作流
- **原型设计**：快速内容原型制作

